<!doctype html><html lang="ja"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TRIW記事</title>
<style>
  body{font:16px/1.7 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:24px;color:#222}
  main{max-width:900px;margin:auto}
  a{color:#0366d6;text-decoration:none}a:hover{text-decoration:underline}
  pre{overflow:auto;background:#f6f8fa;padding:12px;border-radius:6px}
  h1{font-size:1.8rem;margin:0 0 1rem}
  hr{margin:2rem 0}
  /* 画像の枠線＋余白（下広め） */
  main img{
    display:block;max-width:100%;height:auto;
    border:1px solid #e1e4e8;border-radius:6px;background:#fff;
    box-sizing:border-box;margin:8px 0 32px;
  }
  main a>img{border:1px solid #e1e4e8;border-radius:6px}
  /* 前へ / 次へ */
  .nav-pager{display:flex;justify-content:space-between;gap:12px;align-items:center;margin:32px 0 8px}
  .nav-pager a{display:inline-block;padding:8px 12px;border:1px solid #e1e4e8;border-radius:8px;text-decoration:none}
  .nav-pager a:hover{background:#f6f8fa}
  .nav-pager .spacer{flex:1}
</style>
<main id="app">読み込み中…</main>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const app = document.getElementById('app');
  const fileParam = new URLSearchParams(location.search).get('file') || '';
  // プロジェクトPagesのルート（/triw-writing）を安定検出
  const pathParts = location.pathname.split('/').filter(Boolean);
  const repoRoot = pathParts.length ? '/' + pathParts[0] : '';

  // 章ファイルが指定されていない時はエラー
  if(!fileParam){
    app.textContent = 'エラー: file パラメータが必要です（例: reader.html?file=triw-dev-history/01_zenya.md）';
  }

  function cleanMarkdown(md){
    // YAML front matter
    if (/^---\s*\r?\n/.test(md)) md = md.replace(/^---\s*[\s\S]*?\r?\n---\s*\r?\n?/, '');
    // 先頭に残ったlayout/title行
    md = md.replace(/^(?:layout:.*|title:.*)\s*\r?\n/gi, '');
    // [TOC]
    md = md.replace(/^\s*\[TOC\]\s*$/gmi, '');
    return md.trimStart();
  }

  async function fetchText(url){
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error(`取得失敗: ${url} (${res.status})`);
    return res.text();
  }

  async function loadTocList(){
    // 目次は /<repo>/index.md を見る
    const tocUrl = `${repoRoot}/index.md`;
    const raw = await fetchText(tocUrl);
    const links = [...raw.matchAll(/\[([^\]]+)\]\(([^)]+\.md)\)/g)]
      .map(m => ({ title: m[1], path: m[2].replace(/^\.\//,'') }));
    // 一意化
    const seen = new Set();
    return links.filter(x => !seen.has(x.path) && seen.add(x.path) === true);
  }

  function rewriteLinksAndImages(container, chapterBaseUrl){
    // a要素：.md は自分（reader.html）で開く。他は絶対URLに正規化
    container.querySelectorAll('a[href]').forEach(a=>{
      const href = a.getAttribute('href');
      if(!href || href.startsWith('#') || /^https?:/i.test(href)) return;
      const url = new URL(href, chapterBaseUrl);
      if(url.pathname.endsWith('.md')){
        const rel = url.pathname.replace(new RegExp('^' + repoRoot + '/'), '').replace(/^\//,'');
        a.href = `${repoRoot}/reader.html?file=${encodeURIComponent(rel)}`;
      }else{
        a.href = url.href;
      }
    });
    // img要素：章基準で絶対URLに
    container.querySelectorAll('img[src]').forEach(img=>{
      const src = img.getAttribute('src');
      if(!src || /^https?:/i.test(src) || src.startsWith('data:')) return;
      const url = new URL(src, chapterBaseUrl);
      img.src = url.href;
      img.loading = 'lazy';
      img.decoding = 'async';
    });
  }

  function insertPrevNext(toc, currentPath){
    const i = toc.findIndex(x => x.path === currentPath);
    if(i < 0) return;
    const prev = i > 0 ? toc[i-1] : null;
    const next = i < toc.length - 1 ? toc[i+1] : null;
    const nav = document.createElement('nav');
    nav.className = 'nav-pager';
    nav.innerHTML = `
      ${prev ? `<a href="${repoRoot}/reader.html?file=${encodeURIComponent(prev.path)}">← ${prev.title}</a>` : `<span></span>`}
      <span class="spacer"></span>
      ${next ? `<a href="${repoRoot}/reader.html?file=${encodeURIComponent(next.path)}">${next.title} →</a>` : `<span></span>`}
    `;
    app.prepend(nav.cloneNode(true));
    app.appendChild(nav);
  }

  (async () => {
    try{
      const chapterPath = fileParam.replace(/^\/?triw-writing\//,'').replace(/^\//,'');
      const chapterUrl = new URL(chapterPath, location.origin + repoRoot + '/'); // 章の基準URL
      const raw = await fetchText(chapterUrl.href);
      const md = cleanMarkdown(raw);
      app.innerHTML = marked.parse(md);
      rewriteLinksAndImages(app, chapterUrl);

      // 目次を読んで前後リンク
      try{
        const toc = await loadTocList();
        insertPrevNext(toc, chapterPath, repoRoot);
      }catch(e){
        console.warn('前後リンク生成をスキップ:', e.message);
      }
    }catch(e){
      app.innerHTML = `<p>エラー: ${e.message}</p>`;
    }
  })();
</script>
</html>
