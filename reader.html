<!doctype html><html lang="ja"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TRIW記事</title>
<style>
  body{font:16px/1.7 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:24px;color:#222}
  main{max-width:900px;margin:auto}
  a{color:#0366d6;text-decoration:none}a:hover{text-decoration:underline}
  pre{overflow:auto;background:#f6f8fa;padding:12px;border-radius:6px}
  h1{font-size:1.8rem;margin:0 0 1rem}
  hr{margin:2rem 0}
</style>
<main id="app">読み込み中…</main>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const el = document.getElementById('app');
  const file = new URLSearchParams(location.search).get('file');

  function cleanMarkdown(md) {
    if (/^---\s*\r?\n/.test(md)) md = md.replace(/^---\s*[\s\S]*?\r?\n---\s*\r?\n?/, '');
    md = md.replace(/^(?:layout:.*|title:.*)\s*\r?\n/gi, '');
    md = md.replace(/^\s*\[TOC\]\s*$/gmi, '');
    return md.trimStart();
  }

  (async () => {
    try {
      if (!file) throw new Error("file パラメータが必要です");
      const res = await fetch(file, { cache: 'no-store' });
      if (!res.ok) throw new Error(`取得失敗: ${file}`);
      const base = new URL(file, location.href);      // ← 章ファイルの場所
      const md = cleanMarkdown(await res.text());
      el.innerHTML = marked.parse(md);

      // 1) a要素のリンク補正（.md は自分で開く）
      [...el.querySelectorAll('a[href]')].forEach(a => {
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || /^https?:/i.test(href)) return;
        const url = new URL(href, base);
        if (url.pathname.endsWith('.md')) {
          a.href = `${location.pathname}?file=${decodeURIComponent(url.pathname.replace(/^\/triw-writing\//,'')).replace(/^\//,'')}`;
        } else {
          a.href = url.href; // 絶対URLに正規化
        }
      });

      // 2) 画像のsrc補正（章ファイル基準で絶対URLに）
      [...el.querySelectorAll('img[src]')].forEach(img => {
        try {
          const src = img.getAttribute('src');
          if (!src || /^https?:/i.test(src) || src.startsWith('data:')) return;
          const url = new URL(src, base);
          img.src = url.href;
          img.loading = 'lazy';
          img.decoding = 'async';
        } catch {}
      });
    } catch (e) {
      el.innerHTML = `<p>エラー: ${e.message}</p>`;
    }
  })();
</script>

</html>
