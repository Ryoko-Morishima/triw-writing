<!doctype html><html lang="ja"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TRIW記事</title>
<style>
  body{font:16px/1.7 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:24px;color:#222}
  main{max-width:900px;margin:auto}
  a{color:#0366d6;text-decoration:none}a:hover{text-decoration:underline}
  pre{overflow:auto;background:#f6f8fa;padding:12px;border-radius:6px}
  h1{font-size:1.8rem;margin:0 0 1rem}
  hr{margin:2rem 0}
</style>
<main id="app">読み込み中…</main>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const el = document.getElementById('app');
  const file = new URLSearchParams(location.search).get('file');

  function cleanMarkdown(md) {
    // 1) 先頭の YAML フロントマター --- ... --- を除去
    if (/^---\s*\r?\n/.test(md)) {
      md = md.replace(/^---\s*[\s\S]*?\r?\n---\s*\r?\n?/, '');
    }
    // 2) 念のため、先頭に単独で残った layout:/title: 行も除去
    md = md.replace(/^(?:layout:.*|title:.*)\s*\r?\n/gi, '');
    // 3) [TOC] を除去
    md = md.replace(/^\s*\[TOC\]\s*$/gmi, '');
    return md.trimStart();
  }

  (async () => {
    try {
      if (!file) throw new Error("file パラメータが必要です");
      const res = await fetch(file, { cache: 'no-store' });
      if (!res.ok) throw new Error(`取得失敗: ${file}`);
      const raw = await res.text();
      const md = cleanMarkdown(raw);
      el.innerHTML = marked.parse(md);

      // 相対リンクを章ファイル基準に補正し、.mdはreader.htmlで開く
      const base = new URL(file, location.href);
      [...el.querySelectorAll('a[href]')].forEach(a => {
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || /^https?:/i.test(href)) return;
        const url = new URL(href, base);
        if (url.pathname.endsWith('.md')) {
          a.href = `${location.pathname}?file=${decodeURIComponent(
            url.pathname.replace(/^\/triw-writing\//, '').replace(/^\//,'')
          )}`;
        } else {
          a.href = url.href;
        }
      });
    } catch (e) {
      el.innerHTML = `<p>エラー: ${e.message}</p>`;
    }
  })();
</script>

</html>
